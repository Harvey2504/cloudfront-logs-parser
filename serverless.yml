frameworkVersion: "3"

service: cloudfront-logs-parser-lambda-opensearch
useDotenv: true

provider:
  name: aws
  runtime: python3.11
  environment:
    PYTHONPATH: ./src
    AWS_ACCESS_KEY: ${{ secrets.my_aws_access_key }}
    AWS_SECRET_KEY: ${{ secrets.my_aws_secret_key }}
    OPENSEARCH_HOST: ${{ secrets.opensearch_host }}
    OPENSEARCH_USERNAME: ${{ secrets.opensearch_username }}
    OPENSEARCH_PASSWORD: ${{ secrets.opensearch_password }}
  region: ap-south-1
  iam:
    role:
      name: cloudfront-logs-role 

package:
  patterns:
    # exclude everything
    - "!./**"
    # include only what's needed
    - src/cloudfront_parser.py
    - src/lambda_handler.py
    - src/version.py

functions:
  cloudfront-logs-parser-lambda-opensearch:
    handler: src/lambda_handler.handler
    events:
      - s3:
          bucket: test
          event: s3:ObjectCreated:*
          rules:
            - prefix: /test/
              suffix: .gz

plugins:
  - serverless-python-requirements

custom:
  pythonRequirements:
    fileName: requirements-lambda.txt
